{% extends 'base.html' %}

{% block title %}Odontograma - {{ nome_paciente }} - SisDental{% endblock %}

{% block content %}

{# Estilos específicos para esta página (sem alterações) #}
<style>
  /* Estilos do odontograma (mantidos como antes) */
  .odontograma-container {
    display: grid;
    grid-template-columns: 1fr 1fr; /* Ajustado para melhor responsividade talvez */
    grid-template-rows: auto auto;
    gap: 15px 8px;
    margin: 20px auto;
    padding: 15px;
    border: 1px solid var(--bs-border-color, #dee2e6); /* Usa variável Bootstrap */
    border-radius: 8px;
    background-color: var(--bs-body-bg);
  }
  .quadrante { display: flex; justify-content: center; gap: 4px; }
  .quadrante-superior-direito { grid-area: 1 / 1 / 2 / 2; justify-content: flex-end; }
  .quadrante-superior-esquerdo { grid-area: 1 / 2 / 2 / 3; justify-content: flex-start; }
  .quadrante-inferior-direito { grid-area: 2 / 1 / 3 / 2; justify-content: flex-end; }
  .quadrante-inferior-esquerdo { grid-area: 2 / 2 / 3 / 3; justify-content: flex-start; }
  .dente { width: 50px; height: 65px; border: 1px solid var(--bs-border-color-translucent, #ccc); border-radius: 5px; display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer; background-color: var(--bs-tertiary-bg, #fff); color: var(--bs-body-color, #212529); font-size: 0.75em; transition: background-color 0.3s ease, border-color 0.3s ease, color 0.3s ease; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
  .dente i { font-size: 1.6em; margin-bottom: 4px; color: var(--bs-secondary-color, #6c757d); transition: color 0.3s ease, text-decoration 0.3s ease; }
  .dente:hover { border-color: var(--bs-primary, #0d6efd); background-color: var(--bs-secondary-bg, #e9ecef); }

  /* Cores de tratamento - usar cores mais contrastantes com temas */
    /* Cores de tratamento - Aplicadas ao dente OU à caixa da legenda */
    .dente.tratado,
  .legend-color-box.tratado { background-color: #b3e5fc; border-color: #03a9f4; color: #000; }

  .dente.tratado-canal,
  .legend-color-box.tratado-canal { background-color: #ffcdd2; border-color: #f44336; color: #000; }

  .dente.tratado-restauracao,
  .legend-color-box.tratado-restauracao { background-color: #000000; border-color: #6c757d; color: #FFFFFF; }

  .dente.tratado-extracao,
  .legend-color-box.tratado-extracao { background-color: #e0e0e0; border-color: #9e9e9e; color: #757575; }
  /* Estilo específico para ícone de extração permanece apenas no dente */
  .dente.tratado-extracao i { color: #dc3545 !important; text-decoration: line-through; }

  .dente.tratado-limpeza,
  .legend-color-box.tratado-limpeza { background-color: #d1c4e9; border-color: #673ab7; color: #000; }

  .dente.tratado-clareamento,
  .legend-color-box.tratado-clareamento { background-color: #fff9c4; border-color: #ffeb3b; color: #000; }

  .dente.tratado-implante,
  .legend-color-box.tratado-implante { background-color: #bbdefb; border-color: #2196f3; color: #000; }

  .dente.tratado-avaliacao,
  .legend-color-box.tratado-avaliacao { background-color: #ffe0b2; border-color: #ff9800; color: #000; }

  .dente.tratado-outro,
  .legend-color-box.tratado-outro { background-color: #cfd8dc; border-color: #607d8b; color: #000; }

  /* COR VERDE PARA CONCLUÍDO - Aplicada ao dente OU à caixa da legenda */
  .dente.concluido,
  .legend-color-box.concluido {
    background-color: #c8e6c9; /* Verde claro */
    border-color: #4caf50;   /* Verde mais escuro */
    color: #000;
  }
  /* Estilo específico para ícone concluído permanece apenas no dente */
  .dente.concluido i {
     color: #1e4620;
  }

  /* --- Ajustes Tema Escuro --- */

  body.bg-dark .dente.tratado,
  body.bg-dark .legend-color-box.tratado { background-color: #03a9f4; border-color: #b3e5fc; color: #000; }

  body.bg-dark .dente.tratado-canal,
  body.bg-dark .legend-color-box.tratado-canal { background-color: #f44336; border-color: #ffcdd2; color: #fff; }

  body.bg-dark .dente.tratado-restauracao,
  body.bg-dark .legend-color-box.tratado-restauracao { background-color: #000000; border-color: #adb5bd; color: #fff; }

  body.bg-dark .dente.tratado-extracao,
  body.bg-dark .legend-color-box.tratado-extracao { background-color: #9e9e9e; border-color: #e0e0e0; color: #000; }
  /* Estilo específico para ícone de extração no tema escuro */
  body.bg-dark .dente.tratado-extracao i { color: #ffcdd2 !important; }

  body.bg-dark .dente.tratado-limpeza,
  body.bg-dark .legend-color-box.tratado-limpeza { background-color: #673ab7; border-color: #d1c4e9; color: #fff; }

  body.bg-dark .dente.tratado-clareamento,
  body.bg-dark .legend-color-box.tratado-clareamento { background-color: #ffeb3b; border-color: #fff9c4; color: #000; }

  body.bg-dark .dente.tratado-implante,
  body.bg-dark .legend-color-box.tratado-implante { background-color: #2196f3; border-color: #bbdefb; color: #fff; }

  body.bg-dark .dente.tratado-avaliacao,
  body.bg-dark .legend-color-box.tratado-avaliacao { background-color: #ff9800; border-color: #ffe0b2; color: #000; }

  body.bg-dark .dente.tratado-outro,
  body.bg-dark .legend-color-box.tratado-outro { background-color: #607d8b; border-color: #cfd8dc; color: #fff; }

  /* Ajuste CONCLUÍDO para tema escuro */
  body.bg-dark .dente.concluido,
  body.bg-dark .legend-color-box.concluido {
    background-color: #4caf50; /* Verde mais escuro */
    border-color: #c8e6c9;   /* Verde claro */
    color: #fff;
  }
  /* Estilo específico para ícone concluído no tema escuro */
   body.bg-dark .dente.concluido i {
     color: #e8f5e9;
  }

 
  /* Adicione dentro da tag <style> existente */

    .legend-color-box {
    display: inline-block;
    width: 20px;
    height: 20px;
    border: 1px solid #ccc;
    vertical-align: middle; /* Alinha verticalmente com o texto */
    margin-right: 8px; /* Espaço entre a caixa e o texto */
    }

    /* --- Media Query para Responsividade --- */
@media (max-width: 1068px) {
  .odontograma-container {
    grid-template-columns: 1fr; /* Muda para 1 coluna */
    grid-template-rows: auto auto auto auto; /* 4 linhas para os quadrantes */
    gap: 25px 10px; /* Aumenta um pouco o espaço vertical entre quadrantes */
    max-width: 95%; /* Permite ocupar quase toda a largura */
    padding: 10px; /* Reduz padding interno */
  }

  /* Remove as áreas específicas do grid para permitir o fluxo natural */
  .quadrante-superior-direito,
  .quadrante-superior-esquerdo,
  .quadrante-inferior-direito,
  .quadrante-inferior-esquerdo {
    grid-area: auto; /* Deixa o grid auto-posicionar */
    justify-content: center; /* Centraliza os dentes no quadrante */
  }

  /* Opcional: Reduzir um pouco o tamanho dos dentes em telas muito pequenas */
  @media (max-width: 420px) {
      .dente {
          width: 40px;
          height: 55px;
          font-size: 0.7em;
      }
      .dente i {
          font-size: 1.4em;
      }
      .quadrante {
          gap: 3px; /* Reduz gap entre dentes */
      }
  }
}
</style>

<h2 class="text-center mb-4">Odontograma Interativo - {{ nome_paciente }}</h2>

<!-- Estrutura do Odontograma (HTML mantido) -->
<div class="odontograma-container">
  <div class="quadrante quadrante-superior-direito">{% for i in range(18, 10, -1) %}<div class="dente" data-numero="{{ i }}"><i class="fa-solid fa-tooth"></i>{{ i }}</div>{% endfor %}</div>
  <div class="quadrante quadrante-superior-esquerdo">{% for i in range(21, 29) %}<div class="dente" data-numero="{{ i }}"><i class="fa-solid fa-tooth"></i>{{ i }}</div>{% endfor %}</div>
  <div class="quadrante quadrante-inferior-direito">{% for i in range(48, 40, -1) %}<div class="dente" data-numero="{{ i }}"><i class="fa-solid fa-tooth"></i>{{ i }}</div>{% endfor %}</div>
  <div class="quadrante quadrante-inferior-esquerdo">{% for i in range(31, 39) %}<div class="dente" data-numero="{{ i }}"><i class="fa-solid fa-tooth"></i>{{ i }}</div>{% endfor %}</div>
</div>

<!-- Card da Legenda de Cores -->
<div class="card mt-4 mb-4 shadow-sm">
    <div class="card-header bg-light">
      <h5 class="mb-0"><i class="fas fa-palette me-2"></i>Legenda de Cores</h5>
    </div>
    <div class="card-body">
      <div class="row">
        {# Coluna 1 #}
        <div class="col-md-6 col-lg-4 mb-2">
          <div class="d-flex align-items-center">
            <span class="legend-color-box concluido"></span>
            <span>Tratamento Concluído</span>
          </div>
        </div>
        <div class="col-md-6 col-lg-4 mb-2">
          <div class="d-flex align-items-center">
            <span class="legend-color-box tratado-canal"></span>
            <span>Canal (Em Andamento)</span>
          </div>
        </div>
        <div class="col-md-6 col-lg-4 mb-2">
          <div class="d-flex align-items-center">
            <span class="legend-color-box tratado-restauracao"></span>
            <span>Restauração (Em Andamento)</span>
          </div>
        </div>
  
        {# Coluna 2 #}
        <div class="col-md-6 col-lg-4 mb-2">
          <div class="d-flex align-items-center">
            <span class="legend-color-box tratado-extracao"></span>
            <span>Extração (Indicada/Realizada)</span>
          </div>
        </div>
         <div class="col-md-6 col-lg-4 mb-2">
          <div class="d-flex align-items-center">
            <span class="legend-color-box tratado-limpeza"></span>
            <span>Limpeza (Em Andamento)</span>
          </div>
        </div>
        <div class="col-md-6 col-lg-4 mb-2">
          <div class="d-flex align-items-center">
            <span class="legend-color-box tratado-clareamento"></span>
            <span>Clareamento (Em Andamento)</span>
          </div>
        </div>
  
        {# Coluna 3 #}
         <div class="col-md-6 col-lg-4 mb-2">
          <div class="d-flex align-items-center">
            <span class="legend-color-box tratado-implante"></span>
            <span>Implante (Em Andamento)</span>
          </div>
        </div>
        <div class="col-md-6 col-lg-4 mb-2">
          <div class="d-flex align-items-center">
            <span class="legend-color-box tratado-avaliacao"></span>
            <span>Avaliação (Em Andamento)</span>
          </div>
        </div>
        <div class="col-md-6 col-lg-4 mb-2">
          <div class="d-flex align-items-center">
            <span class="legend-color-box tratado-outro"></span>
            <span>Outro (Em Andamento)</span>
          </div>
        </div>
         {# Você pode adicionar mais se tiver outros status/cores #}
         {# Exemplo: Dente sem tratamento (cor padrão) #}
         <div class="col-md-6 col-lg-4 mb-2">
          <div class="d-flex align-items-center">
            <span class="legend-color-box" style="background-color: var(--bs-tertiary-bg, #fff);"></span>
            <span>Sem Tratamento Ativo</span>
          </div>
        </div>
  
      </div>
    </div>
  </div>
  <!-- Fim do Card da Legenda -->
  

<hr class="my-4">

<h3 class="text-center mb-3">Tratamentos Registrados</h3>
<!-- Tabela de Tratamentos (THEAD atualizado com Valor, Colspan atualizado) -->
<div class="table-responsive">
  <table id="tabelaTratamentos" class="table table-striped table-bordered table-hover">
    <thead class="table-dark">
      <tr>
        <th>Dente</th>
        <th>Tratamento</th>
        <th>Data</th>
        <th>Observações</th>
        <th>Próxima Sessão</th>
        <th>Valor (R$)</th> {# <-- NOVA COLUNA VALOR #}
        <th>Status</th>
        <th>Ações</th>
      </tr>
    </thead>
    <tbody>
       {# Colspan ajustado para 8 #}
       <tr><td colspan="8" class="text-center">Carregando tratamentos...</td></tr>
    </tbody>
  </table>
</div>

<!-- Modal (Formulário atualizado com Valor) -->
<div class="modal fade" id="modalTratamento" tabindex="-1" aria-labelledby="modalTratamentoLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="modalTratamentoLabel">Cadastrar Tratamento - Dente <span id="modalDenteNumero"></span></h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="formTratamento">
          <input type="hidden" id="formDenteNumero">
          <div class="mb-3"><label for="formTipoTratamento" class="form-label">Tipo de Tratamento</label><select id="formTipoTratamento" class="form-select" required><option value="" selected disabled>Selecione...</option><option value="Canal">Canal</option><option value="Restauração">Restauração</option><option value="Extração">Extração</option><option value="Limpeza">Limpeza</option><option value="Clareamento">Clareamento</option><option value="Implante">Implante</option><option value="Avaliação">Avaliação</option><option value="Outro">Outro</option></select></div>
          <div class="mb-3"><label for="formData" class="form-label">Data</label><input type="date" id="formData" class="form-control" required></div>
          <div class="mb-3"><label for="formObservacoes" class="form-label">Observações</label><textarea id="formObservacoes" class="form-control" rows="2"></textarea></div>
          <div class="mb-3"><label for="formProximaSessao" class="form-label">Próxima Sessão (Opcional)</label><input type="date" id="formProximaSessao" class="form-control"></div>
          {# NOVO CAMPO VALOR #}
          <div class="mb-3">
            <label for="formValor" class="form-label">Valor (R$)</label>
            <input type="number" id="formValor" class="form-control" step="0.01" min="0" placeholder="Ex: 150.00">
          </div>
          {# FIM NOVO CAMPO VALOR #}
          <div class="form-check mb-3">
            <input class="form-check-input" type="checkbox" value="" id="formConcluido">
            <label class="form-check-label" for="formConcluido">
              Marcar como Concluído
            </label>
          </div>
          <div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button><button type="submit" class="btn btn-primary">Salvar Tratamento</button></div>
        </form>
      </div>
    </div>
  </div>
</div>

{# Script atualizado #}
<script>
 document.addEventListener('DOMContentLoaded', function() {
    // --- Seletores Essenciais (adicionado formValorInput) ---
    const dentes = document.querySelectorAll('.dente');
    const modalElement = document.getElementById('modalTratamento');
    const modalTitle = document.getElementById('modalTratamentoLabel');
    const modalDenteNumeroSpan = document.getElementById('modalDenteNumero');
    const formTratamento = document.getElementById('formTratamento');
    const formDenteNumeroInput = document.getElementById('formDenteNumero');
    const formTipoTratamentoSelect = document.getElementById('formTipoTratamento');
    const formDataInput = document.getElementById('formData');
    const formObservacoesTextarea = document.getElementById('formObservacoes');
    const formProximaSessaoInput = document.getElementById('formProximaSessao');
    const formValorInput = document.getElementById('formValor'); // <-- NOVO SELETOR
    const formConcluidoCheckbox = document.getElementById('formConcluido');
    const tabelaTratamentosBody = document.getElementById('tabelaTratamentos')?.querySelector('tbody');

    // --- Inicialização do Modal Bootstrap ---
    let modal = null;
    if (modalElement) {
        modal = new bootstrap.Modal(modalElement);
        console.log("Instância do Modal Bootstrap criada.");
    } else {
        console.error("Erro Crítico: Elemento do modal #modalTratamento não encontrado! O modal não funcionará.");
    }

    // --- Variáveis Globais do Script ---
    let tratamentosSalvos = [];
    const PACIENTE_ID = "{{ paciente_id }}";

    // --- Verificação Inicial ---
    if (!PACIENTE_ID) {
        console.error("Erro Crítico: PACIENTE_ID não definido! Verifique se 'paciente_id' está sendo passado no contexto do template.");
        if (tabelaTratamentosBody) {
            // Colspan atualizado para 8
            tabelaTratamentosBody.innerHTML = '<tr><td colspan="8" class="text-center text-danger">Erro: ID do Paciente não encontrado. Não é possível carregar ou salvar tratamentos.</td></tr>';
        }
    } else {
        console.log("PACIENTE_ID encontrado:", PACIENTE_ID);
    }

    if (!tabelaTratamentosBody) {
        console.error("Erro: Elemento tbody da tabela #tabelaTratamentos não encontrado!");
    }

    // --- Funções Helper ---
    const formatDate = (dateString) => {
        if (!dateString) return '-';
        try {
            const date = new Date(dateString + 'T00:00:00');
            if (isNaN(date.getTime())) {
                console.warn("Data inválida recebida:", dateString);
                return dateString;
            }
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const year = date.getFullYear();
            return `${day}/${month}/${year}`;
        } catch (e) {
            console.error("Erro ao formatar data:", dateString, e);
            return dateString;
        }
    };

    // <-- NOVA FUNÇÃO HELPER PARA FORMATAR MOEDA -->
    const formatCurrency = (value) => {
        if (value === null || value === undefined || isNaN(value)) {
            return '-'; // Retorna '-' se não houver valor ou não for número
        }
        try {
            const numericValue = Number(value);
            // Formata como moeda brasileira (Real)
            return numericValue.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
        } catch (e) {
            console.error("Erro ao formatar valor monetário:", value, e);
            return String(value); // Retorna o valor como string em caso de erro
        }
    };

    // --- Funções de Atualização da Interface ---

    function atualizarVisualizacaoDentes() {
        // (Sem alterações nesta função, o valor não afeta a cor do dente)
        console.log("Atualizando visualização dos dentes com:", tratamentosSalvos);
        if (!dentes || dentes.length === 0) {
            console.warn("Nenhum elemento '.dente' encontrado para atualizar.");
            return;
        }
        dentes.forEach(dente => {
            const numeroDente = dente.dataset.numero;
            dente.className = 'dente'; // Reseta classes
            const icon = dente.querySelector('i');
            if (icon) { // Verifica se o ícone existe
                icon.style.textDecoration = 'none';
                icon.style.color = '';
            } else {
                console.warn(`Ícone não encontrado para o dente ${numeroDente}`);
            }

            const tratamentosDesteDente = tratamentosSalvos.filter(t => String(t.dente_numero) === numeroDente);

            if (tratamentosDesteDente.length > 0) {
                const ultimoTratamento = tratamentosDesteDente.sort((a, b) => {
                    const dateA = a.data_tratamento ? new Date(a.data_tratamento) : new Date(0);
                    const dateB = b.data_tratamento ? new Date(b.data_tratamento) : new Date(0);
                    return dateB - dateA;
                })[0];

                if (ultimoTratamento) {
                    dente.classList.add('tratado');
                    if (ultimoTratamento.concluido) {
                        dente.classList.add('concluido');
                    } else if (ultimoTratamento.tipo_tratamento) {
                        const tipoTratamento = ultimoTratamento.tipo_tratamento || 'desconhecido';
                        const tipoTratamentoClass = 'tratado-' + tipoTratamento.toLowerCase()
                            .normalize("NFD").replace(/[\u0300-\u036f]/g, "")
                            .replace(/\s+/g, '-')
                            .replace(/[^a-z0-9-]+/g, '')
                            .replace(/^-+|-+$/g, '');
                        dente.classList.add(tipoTratamentoClass);
                        if (ultimoTratamento.tipo_tratamento === 'Extração' && icon) {
                            icon.style.textDecoration = 'line-through';
                        }
                    } else {
                        console.warn(`Dente ${numeroDente}: Último tratamento sem tipo definido`, ultimoTratamento);
                        dente.classList.add('tratado-outro');
                    }
                }
            }
        });
        console.log("Visualização dos dentes atualizada.");
    }

    function renderizarTabela() {
        // (Atualizada para incluir a coluna Valor e ajustar colspan)
        if (!tabelaTratamentosBody) {
            console.error("Não é possível renderizar tabela: tbody não encontrado.");
            return;
        }
        tabelaTratamentosBody.innerHTML = '';
        if (!Array.isArray(tratamentosSalvos) || tratamentosSalvos.length === 0) {
             // Colspan atualizado para 8
             tabelaTratamentosBody.innerHTML = `<tr><td colspan="8" class="text-center">Nenhum tratamento registrado.</td></tr>`;
             return;
        }
        const tratamentosOrdenados = [...tratamentosSalvos].sort((a, b) => {
             const dateA = a.data_tratamento ? new Date(a.data_tratamento) : new Date(0);
             const dateB = b.data_tratamento ? new Date(b.data_tratamento) : new Date(0);
             return dateA - dateB;
        });

        tratamentosOrdenados.forEach(tratamento => {
            const tr = document.createElement('tr');
            const dataTrat = tratamento.data_tratamento;
            const proxSessao = tratamento.proxima_sessao;
            const isConcluido = tratamento.concluido === true || tratamento.concluido === 'true';

            // Gera o HTML da linha da tabela (8 colunas)
            tr.innerHTML = `
                <td>${tratamento.dente_numero || '?'}</td>
                <td>${tratamento.tipo_tratamento || 'N/A'}</td>
                <td>${formatDate(dataTrat)}</td>
                <td>${tratamento.observacoes || '-'}</td>
                <td>${formatDate(proxSessao)}</td>
                <td>${formatCurrency(tratamento.valor)}</td> {# <-- CÉLULA DO VALOR FORMATADO #}
                <td>
                    ${isConcluido
                        ? '<span class="badge bg-success"><i class="fas fa-check me-1"></i>Concluído</span>'
                        : '<span class="badge bg-warning text-dark"><i class="fas fa-hourglass-half me-1"></i>Em Andamento</span>'
                    }
                </td>
                <td> 
                    <button
                        class="btn btn-${isConcluido ? 'warning' : 'success'} btn-sm toggle-status-btn"
                        data-id="${tratamento.id}"
                        data-novo-status="${!isConcluido}"
                        title="${isConcluido ? 'Marcar como Em Andamento' : 'Marcar como Concluído'}">
                        <i class="fas fa-${isConcluido ? 'undo' : 'check'}"></i>
                    </button>
                    <button
                        class="btn btn-danger btn-sm ms-1 delete-btn"
                        data-id="${tratamento.id}"
                        title="Excluir">
                        <i class="fas fa-trash-alt"></i>
                    </button>
                </td>
            `;
            tabelaTratamentosBody.appendChild(tr);
        });

        // Adiciona listeners aos botões (sem alterações aqui)
        tabelaTratamentosBody.querySelectorAll('.toggle-status-btn').forEach(button => {
            button.addEventListener('click', () => {
                const id = button.dataset.id;
                const novoStatus = button.dataset.novoStatus === 'true';
                toggleStatusTratamento(id, novoStatus);
            });
        });

        tabelaTratamentosBody.querySelectorAll('.delete-btn').forEach(button => {
            button.addEventListener('click', () => {
                const id = button.dataset.id;
                excluirTratamento(id);
            });
        });
        console.log("Tabela de tratamentos renderizada.");
    }

    // --- Funções de Interação com a API ---
    async function carregarTratamentos() {
        // (Sem alterações, mas espera que a API retorne o campo 'valor')
        if (!PACIENTE_ID) {
            console.warn("Não é possível carregar tratamentos: PACIENTE_ID não definido.");
            return;
        }
        console.log(`Carregando tratamentos para paciente ${PACIENTE_ID}...`);
        try {
            const response = await fetch(`/api/odontograma/${PACIENTE_ID}/tratamentos`);
            if (!response.ok) {
                throw new Error(`Erro HTTP ao carregar: ${response.status} ${response.statusText}`);
            }
            const data = await response.json();
            console.log("Tratamentos recebidos da API:", data);
            tratamentosSalvos = data.map(t => ({
                ...t,
                concluido: t.concluido === true || t.concluido === 'true',
                // O campo 'valor' deve vir da API
            }));
            renderizarTabela();
            atualizarVisualizacaoDentes();
        } catch (error) {
            console.error("Erro ao carregar tratamentos:", error);
            if (tabelaTratamentosBody) {
                // Colspan atualizado para 8
                tabelaTratamentosBody.innerHTML = `<tr><td colspan="8" class="text-center text-danger">Erro ao carregar tratamentos: ${error.message}</td></tr>`;
            }
            tratamentosSalvos = [];
            atualizarVisualizacaoDentes();
        }
    }

    async function salvarTratamento(tratamentoData) {
        // (Atualizada para incluir 'valor' no envio e no objeto local)
        if (!PACIENTE_ID) {
            alert("Erro: ID do Paciente não encontrado. Não é possível salvar.");
            console.error("Tentativa de salvar sem PACIENTE_ID.");
            return;
        }
        console.log("Enviando para salvar (camelCase com valor):", tratamentoData);
        try {
            const response = await fetch(`/api/odontograma/${PACIENTE_ID}/tratamentos`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', },
                body: JSON.stringify(tratamentoData),
            });
            const result = await response.json();
            if (!response.ok) { throw new Error(result.erro || `Erro HTTP: ${response.status}`); }
            console.log("Salvo com sucesso (API retornou snake_case com valor):", result);

            // Adiciona o novo tratamento ao array local, incluindo o valor
            const novoTratamento = {
                id: result.id,
                paciente_id: parseInt(PACIENTE_ID),
                dente_numero: result.dente_numero || tratamentoData.denteNumero,
                tipo_tratamento: result.tipo_tratamento || tratamentoData.tipo,
                data_tratamento: result.data_tratamento || tratamentoData.data,
                observacoes: result.observacoes || tratamentoData.observacoes,
                proxima_sessao: result.proxima_sessao || tratamentoData.proximaSessao,
                valor: result.valor !== undefined ? result.valor : (tratamentoData.valor || null), // <-- INCLUI VALOR
                concluido: result.concluido === true || result.concluido === 'true'
            };
            tratamentosSalvos.push(novoTratamento);

            renderizarTabela();
            atualizarVisualizacaoDentes();
            if (modal) modal.hide();
            if (formTratamento) formTratamento.reset(); // Reset deve limpar o campo valor também
        } catch (error) {
            console.error("Erro ao salvar tratamento:", error);
            alert(`Erro ao salvar: ${error.message}`);
        }
    }

    async function toggleStatusTratamento(tratamentoId, novoStatus) {
        // (Sem alterações nesta função)
        console.log(`Alternando status do tratamento ${tratamentoId} para ${novoStatus}`);
        try {
            const response = await fetch(`/api/odontograma/tratamentos/${tratamentoId}/status`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json', },
                body: JSON.stringify({ concluido: novoStatus }),
            });
            const result = await response.json();
            if (!response.ok) { throw new Error(result.erro || `Erro HTTP: ${response.status}`); }

            console.log("Status atualizado com sucesso (API):", result);
            const index = tratamentosSalvos.findIndex(t => String(t.id) === String(tratamentoId));
            if (index !== -1) {
                tratamentosSalvos[index].concluido = novoStatus;
                renderizarTabela();
                atualizarVisualizacaoDentes();
            } else {
                console.error("Tratamento não encontrado localmente para atualizar status:", tratamentoId);
            }
        } catch (error) {
            console.error("Erro ao atualizar status do tratamento:", error);
            alert(`Erro ao atualizar status: ${error.message}`);
        }
    }

    async function excluirTratamento(tratamentoId) {
        // (Sem alterações nesta função)
        if (!confirm(`Tem certeza que deseja excluir o tratamento ID ${tratamentoId}?`)) {
            return;
        }
        console.log(`Excluindo tratamento ${tratamentoId}`);
        try {
            const response = await fetch(`/api/odontograma/tratamentos/${tratamentoId}`, {
                method: 'DELETE',
            });
            if (!response.ok && response.status !== 204) {
                 let errorMsg = `Erro HTTP: ${response.status}`;
                 try {
                     const result = await response.json();
                     errorMsg = result.erro || errorMsg;
                 } catch (e) { /* Ignora erro ao ler json */ }
                 throw new Error(errorMsg);
            }
            console.log("Tratamento excluído com sucesso (API).");
            tratamentosSalvos = tratamentosSalvos.filter(t => String(t.id) !== String(tratamentoId));
            renderizarTabela();
            atualizarVisualizacaoDentes();
        } catch (error) {
            console.error("Erro ao excluir tratamento:", error);
            alert(`Erro ao excluir: ${error.message}`);
        }
    }


    // --- Listeners de Eventos ---
    // Listener para abrir o modal ao clicar no dente (sem alterações diretas aqui)
    if (dentes.length > 0) {
        dentes.forEach(dente => {
            dente.addEventListener('click', () => {
                if (!modal) {
                    console.error("Modal não está inicializado. Não é possível abrir.");
                    alert("Erro: O formulário de tratamento não pode ser aberto.");
                    return;
                }
                const numeroDente = dente.dataset.numero;
                if (modalDenteNumeroSpan) modalDenteNumeroSpan.textContent = numeroDente;
                if (formDenteNumeroInput) formDenteNumeroInput.value = numeroDente;

                if (formTratamento) formTratamento.reset(); // Reseta o formulário (inclui valor)
                if (formDataInput) formDataInput.valueAsDate = new Date();
                if (formConcluidoCheckbox) formConcluidoCheckbox.checked = false;

                modal.show();
            });
        });
    } else {
        console.warn("Nenhum elemento '.dente' encontrado para adicionar listeners.");
    }

    // Listener para salvar o tratamento (atualizado para coletar 'valor')
    if (formTratamento) {
        formTratamento.addEventListener('submit', event => {
            event.preventDefault();
            // Coleta os dados do formulário, incluindo o valor
            const tratamentoData = {
                denteNumero: formDenteNumeroInput.value,
                tipo: formTipoTratamentoSelect.value,
                data: formDataInput.value,
                observacoes: formObservacoesTextarea.value,
                proximaSessao: formProximaSessaoInput.value || null,
                // Converte valor para número ou null se vazio
                valor: formValorInput.value ? parseFloat(formValorInput.value) : null, // <-- COLETA VALOR
                concluido: formConcluidoCheckbox.checked
            };
            // Validação básica
            if (!tratamentoData.denteNumero || !tratamentoData.tipo || !tratamentoData.data) {
                alert("Por favor, preencha o Dente, Tipo de Tratamento e Data.");
                return;
            }
            // Validação opcional para valor (se necessário)
            if (tratamentoData.valor !== null && isNaN(tratamentoData.valor)) {
                 alert("Por favor, insira um valor numérico válido.");
                 return;
            }

            salvarTratamento(tratamentoData);
        });
    } else {
        console.error("Erro Crítico: Formulário #formTratamento não encontrado! Não será possível salvar tratamentos.");
    }

    // --- Inicialização ---
    carregarTratamentos(); // Carrega dados iniciais

 }); // Fim do DOMContentLoaded
</script>
{% endblock %}
