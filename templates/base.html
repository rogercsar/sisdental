<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>{% block title %}SisDental{% endblock %}</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <!-- Adicionar no <head> do base.html ou aqui -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    /* Seus estilos CSS existentes */
    body { transition: background-color 0.2s ease, color 0.2s ease; } /* Adicionado para suavizar */
    body.bg-dark { background-color: #121212 !important; color: #f1f1f1; }
    body.bg-light { background-color: #f8f9fa !important; color: #212529; }
    .navbar-dark { background-color: #1f1f1f !important; }
    .navbar-light { background-color: #ffffff !important; }
    .card-dark { background-color: #2a2a2a; color: #f1f1f1; border: none; }
    .card-light { background-color: #ffffff; color: #212529; border: 1px solid #dee2e6; }
    .list-group-item-dark { background-color: #2a2a2a; color: #f1f1f1; border-color: #444; } /* Adicionado border-color */
    .list-group-item-light { background-color: #fff; color: #212529; }
    .form-control-dark { background-color: #2a2a2a; color: #f1f1f1; border: 1px solid #444; }
    .form-control-light { background-color: #fff; color: #212529; }
    .btn { border-radius: 8px; }
    .alert { margin-top: 15px; }
    .main-content-container { margin-top: 80px; padding-bottom: 70px; min-height: calc(100vh - 80px - 40px); } /* Ajustado min-height */
    .footer { position: fixed; bottom: 0; width: 100%; text-align: center; padding: 10px 0; border-top: 1px solid var(--bs-border-color-translucent); z-index: 1000; height: 40px; transition: background-color 0.2s ease, color 0.2s ease, border-color 0.2s ease; }
    .footer p { font-size: 12px; }
    body.bg-dark .footer { background-color: #1f1f1f; color: #ccc; border-top: 1px solid #333; }
    body.bg-light .footer { background-color: #f8f9fa; color: #6c757d; border-top: 1px solid #dee2e6; }
    @media (max-width: 767px) { .footer p { font-size: 9px; } }
    /* Ícone do botão de tema não precisa de CSS extra se o JS trocar a classe */
  </style>
  {% block styles %}{% endblock %} {# Bloco para estilos específicos da página #}
</head>
<body> {# Classe inicial será definida pelo script abaixo #}

    {# ====================================================== #}
    {# SCRIPT IMEDIATO PARA CLASSES DO BODY                  #}
    {# ====================================================== #}
    <script>
        (function() { // IIFE para evitar poluir escopo global
            try {
                const savedTheme = localStorage.getItem('theme');
                // Considera preferência do sistema APENAS se NADA estiver salvo
                const systemPrefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                const applyDark = savedTheme === 'dark' || (savedTheme === null && systemPrefersDark);

                // Aplica APENAS as classes do BODY imediatamente
                if (applyDark) {
                    document.body.classList.add('bg-dark', 'text-light');
                } else {
                    document.body.classList.add('bg-light', 'text-dark');
                }
                // console.log('[Theme Init - Early] Body class applied:', applyDark ? 'dark' : 'light');
            } catch (e) {
                console.error("[Theme Init - Early] Error applying initial body classes:", e);
                // Fallback seguro para tema claro se houver erro
                document.body.classList.add('bg-light', 'text-dark');
            }
        })(); // Executa imediatamente
    </script>
    {# ====================================================== #}
    {# FIM DO SCRIPT IMEDIATO                                #}
    {# ====================================================== #}

    {# Navbar - SEM classes de tema iniciais (serão aplicadas pelo script posterior) #}
    {% if session.get('logado') %}
    <nav class="navbar navbar-expand-lg fixed-top">
        <div class="container-fluid">
        <a class="navbar-brand d-flex align-items-center" href="{{ url_for('home') }}">
            <img src="{{ url_for('static', filename='logo-sisdental.png') }}" alt="Sisdental Odonto" height="24">
        </a>
        <div class="d-flex align-items-center"> {# Mantém itens à direita #}
            {# Removido o span "Olá, Usuário" para simplificar o layout como no seu original #}
            <a href="{{ url_for('logout') }}" class="btn btn-danger btn-sm">
                <i class="fas fa-sign-out-alt"></i> <span class="d-none d-sm-inline">Sair</span> {# Esconde "Sair" em telas extra pequenas #}
            </a>
            {# Botão de alternar tema - Ícone será ajustado pelo JS #}
            <button id="toggle-theme" class="btn btn-outline-secondary btn-sm ms-2" type="button" title="Alternar Tema">
                <i class="fas fa-moon"></i> {# Ícone inicial, JS vai corrigir #}
            </button>
        </div>
        </div>
    </nav>
    {% endif %}

    {# Container Principal #}
    <div class="container main-content-container">
        {# Flashed Messages #}
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                <div class="alert alert-{{ category }} alert-dismissible fade show mt-3" role="alert"> {# Adicionado mt-3 #}
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        {# Conteúdo Específico da Página #}
        {% block content %}{% endblock %}
    </div>

    {# Footer - CORRIGIDO: Removida a tag {% now %} e usado current_year com fallback #}
    <div class="footer">
        <p class="mb-0">&copy; {{ current_year | default('2025') }} SisDental - Sistema Odontológico. Todos os direitos reservados.</p>
    </div>

    {# Scripts (Bootstrap Bundle OBRIGATÓRIO) #}
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    {# ====================================================== #}
    {# SCRIPT PARA APLICAÇÃO COMPLETA DO TEMA E BOTÃO TOGGLE #}
    {# (Roda após o DOM estar pronto)                        #}
    {# ====================================================== #}
    <script>
        // Seleciona o botão DEPOIS que ele existe no DOM
        const toggleBtn = document.getElementById('toggle-theme');

        // Função COMPLETA para aplicar o tema a todos os elementos
        // (Baseada na sua função original, mas garantindo que seletores funcionem)
        function setTheme(dark) {
            const body = document.body;
            const navbar = document.querySelector('.navbar.fixed-top'); // Mais específico
            const cards = document.querySelectorAll('.card');
            const listItems = document.querySelectorAll('.list-group-item');
            // Seleciona form-control E form-select
            const formElements = document.querySelectorAll('.form-control, .form-select');
            const footer = document.querySelector('.footer');

            // Body (reaplicar para garantir consistência)
            body.classList.toggle('bg-dark', dark);
            body.classList.toggle('text-light', dark);
            body.classList.toggle('bg-light', !dark);
            body.classList.toggle('text-dark', !dark);

            // Navbar
            if (navbar) {
                navbar.classList.toggle('navbar-dark', dark);
                navbar.classList.toggle('navbar-light', !dark);
            }

            // Botão de Tema na Navbar
            if (toggleBtn) {
                toggleBtn.classList.toggle('btn-outline-warning', dark); // Amarelo para tema escuro
                toggleBtn.classList.toggle('btn-outline-light', !dark); // Claro para tema claro (como no seu original)
                const icon = toggleBtn.querySelector('i');
                if (icon) { // Verifica se o ícone existe
                    icon.classList.toggle('fa-moon', !dark); // Mostra lua se NÃO for dark
                    icon.classList.toggle('fa-sun', dark);   // Mostra sol se for dark
                }
            }

            // Cards
            cards.forEach(card => {
                card.classList.toggle('card-dark', dark);
                card.classList.toggle('card-light', !dark);
            });

            // List group items
            listItems.forEach(item => {
                item.classList.toggle('list-group-item-dark', dark);
                item.classList.toggle('list-group-item-light', !dark);
            });

            // Form controls e selects
            formElements.forEach(input => {
                input.classList.toggle('form-control-dark', dark);
                input.classList.toggle('form-control-light', !dark);
                // Adiciona/remove classe específica para select se necessário
                if (input.tagName === 'SELECT') {
                     input.classList.toggle('select-dark', dark);
                }
            });

             // Footer (CSS já deve cuidar, mas JS garante)
             if (footer) {
                 // As classes do body e o CSS específico já devem definir o estilo do footer
             }
            // console.log(`[Theme Apply - Full] Tema ${dark ? 'dark' : 'light'} aplicado.`);
        }

        // Listener para o botão de toggle
        if (toggleBtn) {
            toggleBtn.addEventListener('click', () => {
                try {
                    // Determina o NOVO estado baseado na classe ATUAL do body
                    const currentIsDark = document.body.classList.contains('bg-dark');
                    const newIsDark = !currentIsDark;

                    // Aplica o novo tema a TUDO
                    setTheme(newIsDark);

                    // Salva a preferência
                    localStorage.setItem('theme', newIsDark ? 'dark' : 'light');
                    console.log(`[Theme Toggle] Tema alterado para: ${newIsDark ? 'dark' : 'light'}`);

                } catch (e) {
                    console.error("[Theme Toggle] Error:", e);
                }
            });
        } else {
            console.warn("[Theme Toggle] Botão não encontrado.");
        }

        // Aplicação INICIAL COMPLETA do tema quando o DOM está pronto
        window.addEventListener('DOMContentLoaded', () => {
             console.log("[Theme Init - DOMContentLoaded] Aplicando tema completo...");
             try {
                // Lê a preferência novamente para garantir consistência
                const savedTheme = localStorage.getItem('theme');
                const systemPrefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                const initialDark = savedTheme === 'dark' || (savedTheme === null && systemPrefersDark);
                setTheme(initialDark); // Chama a função completa
             } catch (e) {
                console.error("[Theme Init - DOMContentLoaded] Error:", e);
                setTheme(false); // Fallback
             }
        });
    </script>
    {# ====================================================== #}
    {# FIM DO SCRIPT DO TEMA                                 #}
    {# ====================================================== #}

    {# Bloco para scripts específicos da página #}
    {% block scripts %}{% endblock %}

</body>
</html>
